# Git 协议

Git 可以使用 4 种不同的协议来传输资料，本地协议（local），HTTP 协议，SSH 协议（Secure Shell）以及 Git 协议

## 1. 本地协议
最基本的就是本地协议，其中远程版本库就是同一主机的另一个目录。常见于团队的每个成员都对一个共享的文件系统（例如挂载一个NFS）有用访问权，或者比较少见的多人公用一台电脑的情况。

如果需要使用共享文件系统，就可以从本地版本库克隆（clone），推送（push），以及拉取（pull）
如克隆一个本地版本库，可以执行以下命令
`git clone /srv/git/project.git`

或者以下命令
`git clone file:///srv/git/project.git`
URL 开头明确的指定 file:// 时，Git 会触发平时用于网络传输资料的过程，主要的目的时取得一个没有外部参考或对象的干净版本库副本，通常是从其他版本控制系统导入后或者一些类似情况需要这么做
如果仅是指定路径，或者普通路径，Git 会尝试使用硬连接或者直接复制所需要的文件

要增加一个本地版本库到现有的 Git 项目，可以使用以下命令
`git remote add <local_project> /srv/git/project.git`
然后就可以通过新的远程仓库名 local_project 像在网络上一样从远端版本库推送和拉取更新了

### 优点
基于文件系统的版本库的优点是简单，并且直接使用了现有的文件权限和网络访问权限。 如果你的团队已经有
共享文件系统，建立版本库会十分容易。 只需要像设置其他共享目录一样，把一个裸版本库的副本放到大家都
可以访问的路径，并设置好读/写的权限，就可以了。

这也是快速从别人的工作目录中拉取更新的方法。 如果你和别人一起合作一个项目，他想让你从版本库中拉取
更新时，运行类似 git pull /home/john/project 的命令比推送到服务器再抓取回来简单多了

### 缺点
这种方法的缺点是，通常共享文件系统比较难配置，并且比起基本的网络连接访问，这不方便从多个位置访问。
如果你想从家里推送内容，必须先挂载一个远程磁盘，相比网络连接的访问方式，配置不方便，速度也慢。
值得一提的是，如果你使用的是类似于共享挂载的文件系统时，这个方法不一定是最快的。 访问本地版本库的
速度与你访问数据的速度是一样的。 在同一个服务器上，如果允许 Git 访问本地硬盘，一般的通过 NFS 访问版
本库要比通过 SSH 访问慢。
最终，这个协议并不保护仓库避免意外的损坏。 每一个用户都有“远程”目录的完整 shell 权限，没有方法可以
阻止他们修改或删除 Git 内部文件和损坏仓库。

## 2. HTTP

Git 1.6.6 版本引入一个新的，更智能的协议，让 Git 可以像 SSh 那样智能的协商和传输数据。该协议被称为智能 HTTP 协议。

### 智能 HTTP 协议
智能 HTTP 协议运行在标准的 HTTP/S 端口上并且能够使用各种 HTTP 验证机制，这意味着使用起来会比 SSH 协议简单的多，比如可以使用协议的用户名和密码，免去设置 SSH 公钥

### 哑 HTTP 协议
如果服务器没有提供智能 HTTP 协议的服务，Git 客户端会尝试使用更简单的 “哑” HTTP 协议。哑 HTTP 协议里 Web 服务器仅把裸版本库当作普通文件来对待，提供文件服务。

哑 HTTP 协议的优美之处在于设置起来简单。 基本上，只需要把一个裸版本库放在 HTTP 根目录，设置一个叫做 post-update 的挂钩就可以了 （见 Git钩子）。 此时，只要能访问 web 服务器上你的版本库，就可以克隆你的版本库。 下面是设置从 HTTP 访问版本库的方法：
```
cd <folder_path>
git clone --bare /path/to/git_project gitproject.git
cd gitproject.git
mv hooks/post-update.sample hooks/post-update
```
Git 自带的 post-update 挂钩会默认执行合适的命令（`git update-server-info`），来确保通过 HTTP 的获取和克隆操作正常工作。
这条命令会在用户通过 SSH 像版本库推送之后被执行，然后其他人就可以通过下面的命令来克隆
`git clone https://example/com/gitproject.git`

一般能够提供读写的智能 HTTP 服务和简单的只读的哑 HTTP 服务会被二选一使用，很少有情况将二者混合提供

### 优点
我们只关注 HTTP 协议的优点：
不同的访问方式只需要一个 URL 以及服务器只在需要授权时提示输入授权信息，这两个简便性让终端用户使用Git 变得非常简单。 相比 SSH 协议，可以使用用户名／密码授权是一个很大的优势，这样用户就不必须在使用Git 之前先在本地生成 SSH 密钥对再把公钥上传到服务器。 对非资深的使用者，或者系统上缺少 SSH 相关程序的使用者，HTTP 协议的可用性是主要的优势。 与 SSH 协议类似，HTTP 协议也非常快和高效。

另一个好处是 HTTPS 协议被广泛使用，一般的企业防火墙都会允许这些端口的数据通过。

### 缺点
在一些服务器上，架设 HTTPS 协议的服务端会比 SSH 协议的棘手一些。 除了这一点，用其他协议提供 Git 服务与智能 HTTP 协议相比就几乎没有优势了。
如果你在 HTTP 上使用需授权的推送，管理凭证会比使用 SSH 密钥认证麻烦一些。 然而，你可以选择使用凭证存储工具，比如 macOS 的 Keychain 或者 Windows 的凭证管理器

## SSH 协议

架设 Git 服务器时常用 SSH 协议作为传输协议。 因为大多数环境下服务器已经支持通过 SSH 访问 —— 即使没有也很容易架设。 SSH 协议也是一个验证授权的网络协议；并且，因为其普遍性，架设和使用都很容易。

通过 SSH 协议克隆版本库，可以使用一个指定的 ssh:// 的 URL
`git clone ssh:[user@]server/project.git`

或者一个更简单的 scp 式写法
`git clone [user@]server:project.git`

### 优势
1. SSH 架设简单
2. 通过 SSH 访问是安全的
3. SSH 协议很高效，在传输前会尽量压缩数据

### 缺点
1. 不支持匿名访问 Git 仓库，即使是只读数据，使用这边必须通过 SSH 访问用户主机
2. 如果你要同时提供匿名只读访问和 SSH 协议，那么你除了为自己推送架设 SSH 服务以外， 还得架设一个可以让其他人访问的服务

## Git 协议

Git 协议是包含在 Git 力的一个特殊的守护进程：它监听在一个特定的端口（9418），类似于 SSH服务，但是访问无需任何授权。 要让版本库支持 Git 协议，需要先创建一个 git-daemon-export-ok 文件—— 它是 Git 协议守护进程为这个版本库提供服务的必要条件 —— 但是除此之外没有任何安全措施。 要么谁都可以克隆这个版本库，要么谁也不能。 这意味着，通常不能通过 Git 协议推送。

### 优点
1. 网路传输协议里最快的

### 缺点
1. 缺乏授权授权机制
2. 最难架设的，它要求有自己的守护进程，这就要配置 xinetd、systemd 或者其他的程序，这些工作并不简单。 
3. 它还要求防火墙开放 9418 端口，但是企业防火墙一般不会开放这个非标准端口。而大型的企业防火墙通常会封锁这个端口。